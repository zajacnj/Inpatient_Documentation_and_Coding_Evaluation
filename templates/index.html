<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inpatient Documentation and Coding Evaluation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #003366 0%, #004d99 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .user-info {
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.connected {
            background-color: #28a745;
        }

        .status-dot.disconnected {
            background-color: #dc3545;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            background: #004d99;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .panel-content {
            padding: 20px;
        }

        /* Date Selection */
        .date-selection {
            margin-bottom: 20px;
        }

        .date-selection label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .date-selection input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #004d99;
            color: white;
        }

        .btn-primary:hover {
            background-color: #003366;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-block {
            width: 100%;
        }

        /* Patient List */
        .patient-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .patient-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .patient-item:hover {
            background-color: #f8f9fa;
        }

        .patient-item.selected {
            background-color: #e7f3ff;
            border-left: 3px solid #004d99;
        }

        .patient-checkbox {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .patient-content {
            flex: 1;
        }

        .patient-item .patient-name {
            font-weight: 600;
            color: #333;
        }

        .patient-item .patient-details {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
        }

        .patient-count {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            font-size: 0.9rem;
            color: #666;
        }

        /* Results Panel */
        .results-panel {
            min-height: 600px;
        }

        .results-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #004d99;
        }

        .tab-btn.active {
            color: #004d99;
            border-bottom-color: #004d99;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Results Display */
        .results-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .diagnosis-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .diagnosis-card.principal {
            border-left: 4px solid #004d99;
        }

        .diagnosis-card.secondary {
            border-left: 4px solid #6c757d;
        }

        .diagnosis-card.discrepancy {
            border-left: 4px solid #ffc107;
            background: #fff9e6;
        }

        .diagnosis-card.missing {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
        }

        .diagnosis-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .diagnosis-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .icd-code {
            background: #e7f3ff;
            color: #004d99;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .diagnosis-evidence {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .confidence-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .confidence-high {
            background: #d4edda;
            color: #155724;
        }

        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }

        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #004d99;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Alerts */
        .alert {
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .alert-info {
            background: #e7f3ff;
            color: #004d99;
            border: 1px solid #b8daff;
        }

        .alert-warning {
            background: #fff9e6;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-error {
            background: #fff5f5;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* Summary Stats */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #004d99;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Header Control Actions */
        .header-actions {
            position: absolute;
            top: 50%;
            right: 24px;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header {
            position: relative;
        }

        .control-button {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .control-button:active {
            transform: scale(0.96);
        }

        .quit-button {
            background: rgba(220, 53, 69, 0.3);
            border-color: rgba(220, 53, 69, 0.5);
        }

        .quit-button:hover {
            background: rgba(220, 53, 69, 0.5);
            border-color: rgba(220, 53, 69, 0.7);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Inpatient Documentation and Coding Evaluation</h1>
        <p>AI-powered analysis of clinical documentation against coded diagnoses</p>
        <div class="header-actions">
            <button class="control-button" id="fullscreen-btn" onclick="toggleFullscreen()" title="Press F11 to toggle fullscreen">Enter Fullscreen</button>
            <button class="control-button quit-button" onclick="quitApplication()" title="Close the application">Quit</button>
        </div>
    </div>

    <div style="display: flex; gap: 10px; align-items: center; margin: 12px 24px 0 24px;">
        <button class="btn btn-danger" onclick="shutdownServer()" style="padding: 8px 14px;">
            Quit & Shutdown Server
        </button>
        <span style="font-size: 12px; color: #666;">Saves nothing; simply stops the app and closes the backend.</span>
    </div>

    <div class="container">
        <div class="user-info">
            <div>
                <strong>User:</strong> <span id="username">Loading...</span>
                <span style="margin-left: 20px;"><strong>Session:</strong> <span id="session-id">-</span></span>
            </div>
            <div class="status-indicator">
                <span class="status-dot" id="db-status"></span>
                <span>Database</span>
                <span class="status-dot" id="ai-status" style="margin-left: 15px;"></span>
                <span>VA GPT</span>
            </div>
        </div>

        <div class="alert alert-warning" id="config-alert" style="display: none;">
            <strong>Configuration Required:</strong> Database tables and TIU note types need to be configured.
            Please update <code>config/database_config.json</code> with the correct table names.
        </div>

        <div class="main-content">
            <!-- Left Panel: Patient Selection -->
            <div class="panel">
                <div class="panel-header">Patient Selection</div>
                <div class="panel-content">
                    <div class="date-selection">
                        <label for="start-date">Discharge Date Range</label>
                        <input type="date" id="start-date">
                        <input type="date" id="end-date">
                    </div>

                    <button class="btn btn-primary btn-block" onclick="searchPatients()" style="margin-top: 15px;">
                        Search Discharged Patients
                    </button>

                    <div class="patient-count" id="patient-count">
                        Select a date range to view discharged patients
                    </div>

                    <div style="display: flex; gap: 8px; margin-bottom: 12px; margin-top: 12px;">
                        <button class="btn btn-secondary" onclick="sortPatientsByDate('asc')" style="flex: 1; font-size: 13px;">
                            ðŸ“… Discharge â†‘ (Oldest)
                        </button>
                        <button class="btn btn-secondary" onclick="sortPatientsByDate('desc')" style="flex: 1; font-size: 13px;">
                            ðŸ“… Discharge â†“ (Newest)
                        </button>
                    </div>

                    <div class="patient-list" id="patient-list">
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <p>No patients loaded</p>
                        </div>
                    </div>

                    <div class="specialty-filter" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500; color: #555;">Filter by Specialty</label>
                        <div style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 10px; border-radius: 4px;" id="specialty-list">
                            <!-- Populated dynamically -->
                            <div style="color: #999; font-size: 12px;">Loading specialties...</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px; margin-top: 15px;">
                        <button class="btn btn-success" id="review-btn" onclick="startReview()" disabled style="flex: 2;">
                            Review Hospitalization
                        </button>
                        <button class="btn btn-warning" id="clear-btn" onclick="clearSelectedPatients()" disabled style="flex: 1;">
                            Clear Selected
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="panel results-panel">
                <div class="panel-header">Analysis Results</div>
                <div class="panel-content">
                    <div class="results-tabs">
                        <button class="tab-btn active" onclick="showTab('summary')">Summary</button>
                        <button class="tab-btn" onclick="showTab('ai-diagnoses')">AI Diagnoses</button>
                        <button class="tab-btn" onclick="showTab('coded-diagnoses')">Coded (PTF)</button>
                        <button class="tab-btn" onclick="showTab('comparison')">Comparison</button>
                        <button class="tab-btn" onclick="showTab('raw')">Raw Output</button>
                    </div>

                    <!-- Summary Tab -->
                    <div class="tab-content active" id="tab-summary">
                        <div class="empty-state" id="summary-empty">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>Select a patient and click "Review Hospitalization" to begin analysis</p>
                        </div>
                        <div id="summary-content" style="display: none;">
                            <div class="summary-stats" id="summary-stats"></div>
                            <div id="summary-text"></div>
                        </div>
                    </div>

                    <!-- AI Diagnoses Tab -->
                    <div class="tab-content" id="tab-ai-diagnoses">
                        <div id="ai-diagnoses-content">
                            <p class="empty-state">No AI diagnoses available</p>
                        </div>
                    </div>

                    <!-- Coded Diagnoses Tab -->
                    <div class="tab-content" id="tab-coded-diagnoses">
                        <div id="coded-diagnoses-content">
                            <p class="empty-state">No coded diagnoses available</p>
                        </div>
                    </div>

                    <!-- Comparison Tab -->
                    <div class="tab-content" id="tab-comparison">
                        <div id="comparison-content">
                            <p class="empty-state">No comparison available</p>
                        </div>
                    </div>

                    <!-- Raw Output Tab -->
                    <div class="tab-content" id="tab-raw">
                        <div class="results-box" id="raw-output">
                            // Analysis results will appear here...
                        </div>
                    </div>

                    <!-- Export Buttons -->
                    <div class="export-buttons" id="export-buttons" style="display: none;">
                        <button class="btn btn-secondary" onclick="exportResults('docx')">Export to Word</button>
                        <button class="btn btn-secondary" onclick="exportResults('xlsx')">Export to Excel</button>
                        <button class="btn btn-secondary" onclick="exportResults('pdf')">Export to PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentAnalysis = null;
        window.selectedPatients = [];
        window.currentPatients = [];

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates (last 7 days)
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(lastWeek.getDate() - 7);

            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = lastWeek.toISOString().split('T')[0];

            // Load user info and check status
            loadUserInfo();
            checkSystemStatus();
            loadSpecialties();
        });

        async function loadSpecialties() {
            try {
                const response = await fetch('/api/specialties');
                const data = await response.json();
                
                const specialtyList = document.getElementById('specialty-list');
                specialtyList.innerHTML = '';
                
                if (data.specialties && data.specialties.length > 0) {
                    data.specialties.forEach((specialty, index) => {
                        const id = `specialty-${specialty.id}`;
                        const label = document.createElement('label');
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.style.fontWeight = 'normal';
                        label.style.cursor = 'pointer';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = id;
                        checkbox.name = 'specialty';
                        checkbox.value = specialty.name;
                        checkbox.style.marginRight = '8px';
                        checkbox.style.cursor = 'pointer';
                        
                        const span = document.createElement('span');
                        span.textContent = specialty.name;
                        
                        label.appendChild(checkbox);
                        label.appendChild(span);
                        specialtyList.appendChild(label);
                    });

                    // Bind change handler for client-side filtering
                    const checkboxes = specialtyList.querySelectorAll('input[name="specialty"]');
                    checkboxes.forEach(cb => {
                        cb.addEventListener('change', () => applyClientSideSpecialtyFilter());
                    });
                } else {
                    specialtyList.innerHTML = '<div style="color: #999; font-size: 12px;">No specialties available</div>';
                }
            } catch (error) {
                console.error('Error loading specialties:', error);
                document.getElementById('specialty-list').innerHTML = '<div style="color: #999; font-size: 12px;">Error loading specialties</div>';
            }
        }

        function getSelectedSpecialties() {
            const specialtyCheckboxes = document.querySelectorAll('input[name="specialty"]:checked');
            return Array.from(specialtyCheckboxes)
                .map(cb => cb.value)
                .filter(v => v && v.trim())
                .map(v => v.trim().toUpperCase());
        }

        function applyClientSideSpecialtyFilter() {
            const allPatients = window.allPatients || [];
            const selected = getSelectedSpecialties();

            if (!selected.length) {
                renderPatientList(allPatients);
                document.getElementById('patient-count').textContent = `${allPatients.length} patients found`;
                return;
            }

            const selectedSet = new Set(selected);
            const filtered = allPatients.filter(p => {
                const raw = (p.AdmittingTreatingSpecialtyRaw || p.AdmittingTreatingSpecialty || '').trim().toUpperCase();
                return selectedSet.has(raw);
            });

            renderPatientList(filtered);
            document.getElementById('patient-count').textContent = `${filtered.length} patients found`;
        }

        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info');
                const data = await response.json();
                document.getElementById('username').textContent = data.username;
                document.getElementById('session-id').textContent = data.session_id;
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/diagnostics');
                const data = await response.json();

                // Update status indicators
                const dbStatus = document.getElementById('db-status');
                const aiStatus = document.getElementById('ai-status');

                dbStatus.className = 'status-dot ' + (data.database.connected ? 'connected' : 'disconnected');
                aiStatus.className = 'status-dot ' + (data.va_gpt.initialized ? 'connected' : 'disconnected');

                // Show config alert if needed
                if (!data.configuration.tables_configured) {
                    document.getElementById('config-alert').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        async function searchPatients() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            // Collect selected specialties
            const specialtyCheckboxes = document.querySelectorAll('input[name="specialty"]:checked');
            const selectedSpecialties = Array.from(specialtyCheckboxes).map(cb => cb.value);

            const patientList = document.getElementById('patient-list');
            patientList.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Searching patients...</p></div>';

            try {
                const response = await fetch('/api/patients/discharged', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate,
                        specialties: selectedSpecialties
                    })
                });

                const data = await response.json();

                if (data.success && data.patients && data.patients.length > 0) {
                    window.allPatients = data.patients;
                    applyClientSideSpecialtyFilter();
                } else if (!data.success && data.error) {
                    // Show actual error from backend
                    document.getElementById('patient-count').textContent = 'Error occurred';
                    patientList.innerHTML = `<div class="alert alert-error"><strong>Error:</strong> ${data.error}</div>`;
                    console.error('Backend error:', data.error);
                } else {
                    document.getElementById('patient-count').textContent = 'No patients found';
                    patientList.innerHTML = '<div class="empty-state"><p>No discharged patients found for this date range and selected specialties</p></div>';
                }
            } catch (error) {
                console.error('Error searching patients:', error);
                patientList.innerHTML = '<div class="alert alert-error">Error searching patients. Check console for details.</div>';
            }
        }

        function renderPatientList(patients) {
            const patientList = document.getElementById('patient-list');
            patientList.innerHTML = '';
            
            // Store patients globally for sorting
            window.currentPatients = patients;
            // Initialize selected patients array
            window.selectedPatients = window.selectedPatients || [];

            patients.forEach(patient => {
                const div = document.createElement('div');
                div.className = 'patient-item';
                const patientId = patient.InpatientSID || patient.PatientSID;
                
                // Check if this patient is already selected
                const isSelected = window.selectedPatients.some(p => 
                    (p.InpatientSID || p.PatientSID) === patientId
                );
                
                const rawSpecialty = patient.AdmittingTreatingSpecialtyRaw || patient.AdmittingTreatingSpecialty || 'Unknown';
                const specialtyLabel = rawSpecialty;

                div.innerHTML = `
                    <input type="checkbox" class="patient-checkbox" 
                           data-patient-id="${patientId}"
                           ${isSelected ? 'checked' : ''}
                           onclick="event.stopPropagation()">
                    <div class="patient-content">
                        <div class="patient-name">${patient.PatientName || 'Unknown'}</div>
                        <div class="patient-details">
                            SSN: ${patient.PatientSSN || 'Unknown'}<br>
                            Unique ID: ${patient.InpatientSID || patient.PatientSID || 'Unknown'}<br>
                            Specialty: ${specialtyLabel}<br>
                            Admitted: ${formatDate(patient.AdmissionDate)}<br>
                            Discharged: ${formatDate(patient.DischargeDate)}<br>
                            LOS: ${patient.LOS || 0} days
                        </div>
                    </div>
                `;
                
                // Add checkbox change handler
                const checkbox = div.querySelector('.patient-checkbox');
                checkbox.addEventListener('change', () => togglePatientSelection(patient, checkbox.checked));
                
                // Add click handler to the entire row (toggles checkbox)
                div.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        togglePatientSelection(patient, checkbox.checked);
                    }
                });
                
                // Apply selected styling if checked
                if (isSelected) {
                    div.classList.add('selected');
                }
                
                patientList.appendChild(div);
            });
            
            updateReviewButton();
        }

        function sortPatientsByDate(direction) {
            if (!window.currentPatients || window.currentPatients.length === 0) {
                return;
            }
            
            // Sort by discharge date
            const sorted = [...window.currentPatients].sort((a, b) => {
                const dateA = new Date(a.DischargeDate);
                const dateB = new Date(b.DischargeDate);
                
                if (direction === 'asc') {
                    return dateA - dateB;  // Oldest first
                } else {
                    return dateB - dateA;  // Newest first
                }
            });
            
            // Store sorted patients and re-render
            window.currentPatients = sorted;
            renderPatientList(sorted);
        }

        function togglePatientSelection(patient, isChecked) {
            const patientId = patient.InpatientSID || patient.PatientSID;
            
            if (isChecked) {
                // Add to selected list if not already there
                if (!window.selectedPatients.some(p => (p.InpatientSID || p.PatientSID) === patientId)) {
                    window.selectedPatients.push(patient);
                }
            } else {
                // Remove from selected list
                window.selectedPatients = window.selectedPatients.filter(p => 
                    (p.InpatientSID || p.PatientSID) !== patientId
                );
            }
            
            // Update the visual styling
            const patientItems = document.querySelectorAll('.patient-item');
            patientItems.forEach(item => {
                const checkbox = item.querySelector('.patient-checkbox');
                const itemPatientId = checkbox.getAttribute('data-patient-id');
                if (itemPatientId === patientId.toString()) {
                    if (isChecked) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                }
            });
            
            updateReviewButton();
        }

        function updateReviewButton() {
            const reviewBtn = document.getElementById('review-btn');
            const clearBtn = document.getElementById('clear-btn');
            const count = window.selectedPatients?.length || 0;
            
            if (count === 0) {
                reviewBtn.disabled = true;
                clearBtn.disabled = true;
                reviewBtn.textContent = 'Review Hospitalization';
            } else if (count === 1) {
                reviewBtn.disabled = false;
                clearBtn.disabled = false;
                reviewBtn.textContent = 'Review Hospitalization';
            } else {
                reviewBtn.disabled = false;
                clearBtn.disabled = false;
                reviewBtn.textContent = `Review ${count} Hospitalizations`;
            }
        }

        function clearSelectedPatients() {
            // Clear the selected patients array
            window.selectedPatients = [];
            
            // Uncheck all checkboxes
            const checkboxes = document.querySelectorAll('.patient-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Remove selected styling from all patient items
            const patientItems = document.querySelectorAll('.patient-item');
            patientItems.forEach(item => {
                item.classList.remove('selected');
            });
            
            // Update the review button
            updateReviewButton();
        }

        async function startReview() {
            if (!window.selectedPatients || window.selectedPatients.length === 0) {
                alert('Please select at least one patient first');
                return;
            }

            // Process each patient separately
            for (let i = 0; i < window.selectedPatients.length; i++) {
                const patient = window.selectedPatients[i];
                const patientNum = i + 1;
                const totalPatients = window.selectedPatients.length;
                
                // Show loading state
                document.getElementById('summary-empty').style.display = 'none';
                document.getElementById('summary-content').style.display = 'none';
                
                const progressMsg = totalPatients > 1 
                    ? `<p style="font-size: 0.9rem; color: #004d99;">Processing patient ${patientNum} of ${totalPatients}</p>` 
                    : '';
                
                document.getElementById('tab-summary').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p id="progress-message">Analyzing documentation for ${patient.PatientName}...</p>
                        ${progressMsg}
                        <div id="progress-bar-container" style="width: 100%; max-width: 500px; margin: 20px auto; background: #e0e0e0; border-radius: 10px; height: 24px; display: none;">
                            <div id="progress-bar-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #0066cc, #004d99); border-radius: 10px; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.85rem;">
                                <span id="progress-percentage">0%</span>
                            </div>
                        </div>
                        <p id="progress-step" style="font-size: 0.85rem; color: #666; margin-top: 10px;">Initializing review...</p>
                        <p id="progress-elapsed" style="font-size: 0.75rem; color: #999; margin-top: 5px;">Elapsed: 0s</p>
                    </div>
                `;

                // Start progress polling
                let progressInterval = null;
                
                try {
                    const response = await fetch('/api/review/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            patient_id: patient.PatientID,
                            admission_id: patient.InpatientSID || patient.AdmissionID || patient.PatientID
                        })
                    });

                    const data = await response.json();
                    console.log('Review start response:', data);
                    
                    // If we got a review_id, start polling for progress
                    if (data.review_id || data.analysis_id) {
                        const reviewId = data.review_id || data.analysis_id;
                        console.log('Polling review ID:', reviewId);
                        
                        // Show progress bar
                        document.getElementById('progress-bar-container').style.display = 'block';
                        
                        progressInterval = setInterval(async () => {
                            try {
                                const progressResp = await fetch(`/api/review/progress/${reviewId}`);
                                if (progressResp.status === 404) {
                                    clearInterval(progressInterval);
                                    throw new Error('Review not found. Please restart the review.');
                                }
                                if (!progressResp.ok) {
                                    throw new Error(`Progress check failed: ${progressResp.status}`);
                                }
                                const progress = await progressResp.json();
                                
                                // Update progress bar
                                const progressBar = document.getElementById('progress-bar-fill');
                                const progressPct = document.getElementById('progress-percentage');
                                const progressStep = document.getElementById('progress-step');
                                const progressElapsed = document.getElementById('progress-elapsed');
                                
                                if (progressBar && progress.percentage !== undefined) {
                                    progressBar.style.width = progress.percentage + '%';
                                    if (progressPct) progressPct.textContent = progress.percentage + '%';
                                }
                                
                                if (progressStep && progress.current_step) {
                                    progressStep.textContent = progress.current_step;
                                }
                                
                                if (progressElapsed && progress.elapsed_seconds !== undefined) {
                                    const mins = Math.floor(progress.elapsed_seconds / 60);
                                    const secs = progress.elapsed_seconds % 60;
                                    progressElapsed.textContent = `Elapsed: ${mins}m ${secs}s`;
                                    // DEBUG: Log progress responses to see what the backend is returning
                                    console.log(`[Progress ${reviewId}] Status: ${progress.status}, %: ${progress.percentage}, Step: ${progress.current_step}`);
        
                                }
                                
                                // Stop polling if complete or error
                                if (progress.status === 'complete' || progress.status === 'error') {
                                    clearInterval(progressInterval);
                                    
                                    if (progress.status === 'error') {
                                        throw new Error(progress.error || 'Review failed');
                                    }

                                    // Fetch final results once complete
                                    const resultResp = await fetch(`/api/review/result/${reviewId}`);
                                    const resultData = await resultResp.json();
                                    currentAnalysis = resultData;
                                    renderResults(resultData);
                                }
                            } catch (err) {
                                console.error('Progress polling error:', err);
                                // Don't clear interval on minor errors, keep trying
                            }
                        }, 2000); // Poll every 2 seconds
                    }

                    // If more patients to process, wait a moment before continuing
                    if (i < window.selectedPatients.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                } catch (error) {
                    // Stop progress polling on error
                    if (progressInterval) {
                        clearInterval(progressInterval);
                    }
                    
                    console.error('Error starting review:', error);
                    document.getElementById('tab-summary').innerHTML = `
                        <div class="alert alert-error">
                            Error analyzing documentation for ${patient.PatientName}: ${error.message}
                        </div>
                    `;
                    // Continue to next patient even if this one fails
                }
            }
        }

        function renderResults(data) {
            // Restore summary tab structure
            document.getElementById('tab-summary').innerHTML = `
                <div id="summary-content">
                    <div class="summary-stats" id="summary-stats"></div>
                    <div id="clinical-notes-section"></div>
                    <div id="summary-text"></div>
                </div>
            `;

            // Summary stats
            const stats = document.getElementById('summary-stats');
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${data.documents_analyzed?.notes || 0}</div>
                    <div class="stat-label">Notes Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.ai_analysis?.diagnoses_found || 0}</div>
                    <div class="stat-label">AI Diagnoses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.coded_diagnoses?.length || 0}</div>
                    <div class="stat-label">Coded Diagnoses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.processing_time_seconds || 0}s</div>
                    <div class="stat-label">Processing Time</div>
                </div>
            `;

            // Clinical Notes section
            renderClinicalNotes('clinical-notes-section', data.clinical_notes);

            // Summary text
            const summaryText = document.getElementById('summary-text');
            if (data.ai_analysis?.consolidated?.clinical_summary) {
                summaryText.innerHTML = `
                    <h3 style="margin-bottom: 10px;">Clinical Summary</h3>
                    <p>${data.ai_analysis.consolidated.clinical_summary}</p>
                    ${data.recommendations?.length > 0 ? `
                        <h3 style="margin-top: 20px; margin-bottom: 10px;">Recommendations</h3>
                        <ul>${data.recommendations.map(r => `<li>${r}</li>`).join('')}</ul>
                    ` : ''}
                `;
            } else {
                summaryText.innerHTML = `
                    <h3 style="margin-bottom: 10px;">Clinical Summary</h3>
                    <p class="empty-state">No clinical notes were extracted for this admission.</p>
                `;
            }

            // AI Diagnoses tab
            renderDiagnoses('ai-diagnoses-content', data.ai_analysis?.consolidated);

            // Coded Diagnoses tab
            renderCodedDiagnoses('coded-diagnoses-content', data.coded_diagnoses);

            // Comparison tab
            renderComparison('comparison-content', data.comparison);

            // Raw output
            document.getElementById('raw-output').textContent = JSON.stringify(data, null, 2);

            // Show export buttons
            document.getElementById('export-buttons').style.display = 'flex';
        }

        function renderClinicalNotes(containerId, notes) {
            const container = document.getElementById(containerId);

            if (!notes || notes.length === 0) {
                container.innerHTML = '';
                return;
            }

            const sortSelectId = `${containerId}-note-sort`;
            const tableBodyId = `${containerId}-note-table-body`;
            const noteList = [...notes];

            const renderTable = (order) => {
                const sorted = noteList.slice().sort((a, b) => {
                    const aDate = a.NoteDateTime ? new Date(a.NoteDateTime).getTime() : 0;
                    const bDate = b.NoteDateTime ? new Date(b.NoteDateTime).getTime() : 0;
                    return order === 'desc' ? bDate - aDate : aDate - bDate;
                });

                const rows = sorted.map((note) => {
                    const noteType = note.NoteType || note.note_type || 'Unknown';
                    const noteDate = note.NoteDateTime ? new Date(note.NoteDateTime).toLocaleString() : 'Unknown Date';
                    const author = note.AuthorName || note.author_name || 'Unknown Author';
                    const noteText = note.NoteText || note.note_text || 'No text available';
                    const noteId = note.NoteID || note.note_id || '';

                    return `
                        <tr>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; white-space: nowrap;">${noteDate}</td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee;">
                                <a href="#" class="note-title-link" data-note-title="${noteType.replace(/"/g, '&quot;')}" data-note-author="${author.replace(/"/g, '&quot;')}" data-note-date="${noteDate.replace(/"/g, '&quot;')}" data-note-id="${String(noteId).replace(/"/g, '&quot;')}" data-note-text="${noteText.replace(/"/g, '&quot;')}">
                                    ${noteType}
                                </a>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee;">${author}</td>
                        </tr>
                    `;
                }).join('');

                const tbody = document.getElementById(tableBodyId);
                if (tbody) tbody.innerHTML = rows;
            };

            container.innerHTML = `
                <div style="margin: 20px 0; padding: 15px; background: #f0f7ff; border-left: 4px solid #004d99; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
                        <h3 style="margin: 0; color: #004d99;">Clinical Notes Used for Analysis</h3>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #333;">
                            <label for="${sortSelectId}">Sort:</label>
                            <select id="${sortSelectId}" style="padding: 4px 6px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="asc">Oldest to newest</option>
                                <option value="desc">Newest to oldest</option>
                            </select>
                        </div>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 4px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                                <tr>
                                    <th style="text-align: left; padding: 8px 10px; border-bottom: 1px solid #ddd;">Date</th>
                                    <th style="text-align: left; padding: 8px 10px; border-bottom: 1px solid #ddd;">Note Title</th>
                                    <th style="text-align: left; padding: 8px 10px; border-bottom: 1px solid #ddd;">Author</th>
                                </tr>
                            </thead>
                            <tbody id="${tableBodyId}"></tbody>
                        </table>
                    </div>
                </div>
                <div id="${containerId}-note-modal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
                    <div style="background: white; width: min(900px, 92vw); max-height: 85vh; overflow: hidden; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #eee;">
                            <div>
                                <div id="${containerId}-note-modal-title" style="font-weight: bold; color: #333;"></div>
                                <div id="${containerId}-note-modal-meta" style="font-size: 0.85rem; color: #666;"></div>
                            </div>
                            <button type="button" id="${containerId}-note-modal-close" style="border: none; background: #f0f0f0; padding: 6px 10px; border-radius: 4px; cursor: pointer;">Close</button>
                        </div>
                        <div id="${containerId}-note-modal-body" style="padding: 16px; overflow-y: auto; white-space: pre-wrap; font-size: 0.95rem; color: #333;"></div>
                    </div>
                </div>
            `;

            const sortSelect = document.getElementById(sortSelectId);
            if (sortSelect) {
                sortSelect.addEventListener('change', (e) => {
                    renderTable(e.target.value);
                });
            }

            const modal = document.getElementById(`${containerId}-note-modal`);
            const modalTitle = document.getElementById(`${containerId}-note-modal-title`);
            const modalMeta = document.getElementById(`${containerId}-note-modal-meta`);
            const modalBody = document.getElementById(`${containerId}-note-modal-body`);
            const modalClose = document.getElementById(`${containerId}-note-modal-close`);

            const closeModal = () => {
                if (modal) modal.style.display = 'none';
            };

            if (modalClose) {
                modalClose.addEventListener('click', closeModal);
            }
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
            }

            container.addEventListener('click', (e) => {
                const link = e.target.closest('.note-title-link');
                if (!link) return;
                e.preventDefault();

                const title = link.getAttribute('data-note-title') || 'Note';
                const author = link.getAttribute('data-note-author') || 'Unknown Author';
                const date = link.getAttribute('data-note-date') || 'Unknown Date';
                const noteId = link.getAttribute('data-note-id');
                const text = link.getAttribute('data-note-text') || 'No text available';

                if (modalTitle) modalTitle.textContent = title;
                if (modalMeta) {
                    modalMeta.textContent = `${date} | ${author}${noteId ? ` | ID: ${noteId}` : ''}`;
                }
                if (modalBody) modalBody.textContent = text;
                if (modal) modal.style.display = 'flex';
            });

            renderTable('asc');
        }

        function renderDiagnoses(containerId, consolidated) {
            const container = document.getElementById(containerId);

            if (!consolidated) {
                container.innerHTML = '<p class="empty-state">No AI diagnoses extracted</p>';
                return;
            }

            let html = '';

            // Principal diagnosis
            if (consolidated.principal_diagnosis) {
                const pd = consolidated.principal_diagnosis;
                html += `
                    <div class="diagnosis-card principal">
                        <div class="diagnosis-header">
                            <div>
                                <span class="diagnosis-name">${pd.name}</span>
                                <span class="confidence-badge confidence-${pd.confidence?.toLowerCase() || 'medium'}">${pd.confidence || 'MEDIUM'}</span>
                            </div>
                            <span class="icd-code">${pd.icd10_code || 'Not coded'}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">Principal Diagnosis</div>
                        ${pd.evidence ? `<div class="diagnosis-evidence"><strong>Evidence:</strong> ${Array.isArray(pd.evidence) ? pd.evidence.join(', ') : pd.evidence}</div>` : ''}
                    </div>
                `;
            }

            // Secondary diagnoses
            if (consolidated.secondary_diagnoses) {
                consolidated.secondary_diagnoses.forEach(dx => {
                    html += `
                        <div class="diagnosis-card secondary">
                            <div class="diagnosis-header">
                                <div>
                                    <span class="diagnosis-name">${dx.name}</span>
                                    <span class="confidence-badge confidence-${dx.confidence?.toLowerCase() || 'medium'}">${dx.confidence || 'MEDIUM'}</span>
                                    ${dx.cc_mcc ? `<span style="margin-left: 5px; font-size: 0.75rem; color: #666;">(${dx.cc_mcc})</span>` : ''}
                                </div>
                                <span class="icd-code">${dx.icd10_code || 'Not coded'}</span>
                            </div>
                            ${dx.evidence ? `<div class="diagnosis-evidence"><strong>Evidence:</strong> ${Array.isArray(dx.evidence) ? dx.evidence.join(', ') : dx.evidence}</div>` : ''}
                        </div>
                    `;
                });
            }

            container.innerHTML = html || '<p class="empty-state">No diagnoses extracted</p>';
        }

        function renderCodedDiagnoses(containerId, diagnoses) {
            const container = document.getElementById(containerId);

            if (!diagnoses || diagnoses.length === 0) {
                container.innerHTML = '<p class="empty-state">No coded diagnoses from PTF</p>';
                return;
            }

            let html = '';
            diagnoses.forEach((dx, index) => {
                html += `
                    <div class="diagnosis-card ${index === 0 ? 'principal' : 'secondary'}">
                        <div class="diagnosis-header">
                            <span class="diagnosis-name">${dx.DiagnosisDescription || 'Unknown'}</span>
                            <span class="icd-code">${dx.ICD10Code || 'N/A'}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">
                            Sequence: ${dx.DiagnosisSequence || index + 1}
                            ${dx.POAIndicator ? ` | POA: ${dx.POAIndicator}` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderComparison(containerId, comparison) {
            const container = document.getElementById(containerId);

            if (!comparison) {
                container.innerHTML = '<p class="empty-state">No comparison available</p>';
                return;
            }

            let html = '';

            // ================================================================
            // ORIGINAL COMPARISON (BASIC MATCHES)
            // ================================================================
            if (comparison) {
                // Matches
                if (comparison.matches?.length > 0) {
                    html += '<h3 style="margin-top: 20px; margin-bottom: 10px; color: #28a745;">Diagnosis Matches</h3>';
                    comparison.matches.forEach(match => {
                        html += `
                            <div class="diagnosis-card" style="border-left-color: #28a745;">
                                <span class="diagnosis-name">${match.documented || match.coded}</span>
                                <span class="icd-code">${match.icd10 || 'N/A'}</span>
                            </div>
                        `;
                    });
                }

                // Documented but not coded
                if (comparison.documented_not_coded?.length > 0) {
                    html += '<h3 style="margin: 20px 0 10px; color: #ffc107;">Documented but Not Coded</h3>';
                    comparison.documented_not_coded.forEach(item => {
                        html += `
                            <div class="diagnosis-card discrepancy">
                                <div class="diagnosis-header">
                                    <span class="diagnosis-name">${item.diagnosis}</span>
                                    <span class="icd-code">${item.suggested_icd10 || 'Needs review'}</span>
                                </div>
                                ${item.evidence ? `<div class="diagnosis-evidence"><strong>Evidence:</strong> ${item.evidence}</div>` : ''}
                                ${item.impact ? `<div style="margin-top: 8px; font-size: 0.85rem;"><strong>Impact:</strong> ${item.impact}</div>` : ''}
                            </div>
                        `;
                    });
                }

                // Coded but not documented
                if (comparison.coded_not_documented?.length > 0) {
                    html += '<h3 style="margin: 20px 0 10px; color: #dc3545;">Coded but Not Clearly Documented</h3>';
                    comparison.coded_not_documented.forEach(item => {
                        html += `
                            <div class="diagnosis-card missing">
                                <div class="diagnosis-header">
                                    <span class="diagnosis-name">${item.description || 'Unknown'}</span>
                                    <span class="icd-code">${item.icd10 || 'N/A'}</span>
                                </div>
                                ${item.concern ? `<div class="diagnosis-evidence"><strong>Concern:</strong> ${item.concern}</div>` : ''}
                            </div>
                        `;
                    });
                }

                // Summary
                if (comparison.summary) {
                    html += `
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Summary:</strong> ${comparison.summary}
                        </div>
                    `;
                }
            }

            container.innerHTML = html || '<p class="empty-state">No comparison data available</p>';
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function exportResults(format) {
            if (!currentAnalysis || !selectedPatient) {
                alert('No analysis results to export');
                return;
            }

            try {
                // Show loading message
                const originalText = event.target.textContent;
                event.target.textContent = `Generating ${format.toUpperCase()}...`;
                event.target.disabled = true;

                // Prepare analysis data for export
                const analysisPayload = {
                    summary: {
                        notes_count: currentAnalysis.summary?.notes_count || 0,
                        vitals_count: currentAnalysis.summary?.vitals_count || 0,
                        labs_count: currentAnalysis.summary?.labs_count || 0,
                        coded_diagnoses_count: currentAnalysis.coded_diagnoses?.length || 0
                    },
                    ai_analysis: {
                        diagnoses: currentAnalysis.ai_analysis?.diagnoses || []
                    },
                    coded_diagnoses: currentAnalysis.coded_diagnoses || [],
                    comparison: currentAnalysis.comparison || {},
                    recommendations: currentAnalysis.recommendations || []
                };

                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_id: selectedPatient.PatientID,
                        analysis_id: currentAnalysis.analysis_id,
                        format: format,
                        payload: analysisPayload
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ“ Successfully exported to ${format.toUpperCase()}!\nFile: ${data.filename || ''}`);
                } else {
                    alert(data.message || `Export to ${format.toUpperCase()} failed`);
                }

                // Restore button
                event.target.textContent = originalText;
                event.target.disabled = false;
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting results: ' + error.message);
                event.target.disabled = false;
            }
        }

        async function shutdownServer() {
            const confirmQuit = confirm('Quit and shut down the server now?');
            if (!confirmQuit) return;
            try {
                const res = await fetch('/api/shutdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (res.ok) {
                    alert('Server is shutting down. You can close this window.');
                } else {
                    alert('Shutdown request failed.');
                }
            } catch (e) {
                console.error('Shutdown error', e);
                alert('Shutdown request failed.');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Toggle fullscreen mode
        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen().catch(() => {
                    console.log('Could not exit fullscreen');
                });
            } else {
                document.documentElement.requestFullscreen().catch(() => {
                    console.log('Could not enter fullscreen');
                });
            }
        }

        // Update button text based on fullscreen state
        function updateFullscreenButton() {
            const btn = document.getElementById('fullscreen-btn');
            if (btn) {
                if (document.fullscreenElement) {
                    btn.textContent = 'Exit Fullscreen';
                } else {
                    btn.textContent = 'Enter Fullscreen';
                }
            }
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);

        // Auto-enter fullscreen on load
        window.addEventListener('load', function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {
                    console.log('Auto-fullscreen blocked - user can enable with button or F11');
                });
            }
        });

        // Quit application (calls shutdown endpoint)
        async function quitApplication() {
            const confirmed = confirm('Close the application and stop the server?');
            if (!confirmed) return;

            console.log('Initiating shutdown...');
            
            // Send shutdown request to server
            let shutdownSent = false;
            try {
                const response = await fetch('/api/shutdown', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    console.log('Shutdown request acknowledged by server');
                    shutdownSent = true;
                }
            } catch (error) {
                console.error('Shutdown request failed:', error);
            }
            
            // Wait for server to shut down, then close window
            // The launcher_edge.py will detect the server is dead and close Edge
            const delay = shutdownSent ? 1500 : 500;
            await new Promise(resolve => setTimeout(resolve, delay));
            console.log('Closing window...');
            
            // Try multiple methods to close the window
            window.close();
            
            // If window.close() doesn't work (Edge app mode restriction),
            // navigate to blank page - launcher will detect server death and kill Edge
            setTimeout(() => {
                window.location.href = 'about:blank';
            }, 500);
        }

        // F11 toggle fullscreen (for desktop app mode)
        document.addEventListener('keydown', function(event) {
            if (event.key === 'F11') {
                event.preventDefault();
                toggleFullscreen();
            }
        });
    </script>


</body>
</html>
